<!doctype html>
<html lang="hr">
<head>
    <meta charset="utf-8" />
    <title>MedSys – Pacijent</title>
    <link rel="stylesheet" href="/css/site.css">
    <!-- VAŽNO: api.js prije našeg inline koda + cache-busting -->
    <script src="/js/api.js?v=2" defer></script>

    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            const id = qparam('id');
            if (!id) { toast('Nedostaje ?id=... u URL-u'); return; }

            qsel('#back').href = '/index.html';

            async function load() {
                try {
                    const d = await apiGet(`/api/patients/${id}`);
                    const p = d.patient;

                    // Header
                    qsel('#title').textContent = `${p.firstName} ${p.lastName}`;
                    qsel('#pInfo').textContent =
                        `OIB: ${p.oib} • Rođen/a: ${fmtDate(p.birthDate)} • Spol: ${p.sex}` +
                        (p.patientNumber ? ` • Broj pacijenta: ${p.patientNumber}` : '');

                    // Povijest bolesti
                    const mhRows = (d.medicalHistory ?? []).map(x => [
                        x.diseaseName,
                        fmtDate(x.startDate),
                        x.endDate ? fmtDate(x.endDate) : ''
                    ]);
                    fillTable('#tblMh', mhRows);

                    // Pregledi
                    const visitRows = (d.visits ?? []).map(v => {
                        const docsHtml = (v.documents?.length
                            ? v.documents.map(doc =>
                                `<a href="${doc.storageUrl}" target="_blank">${esc(doc.fileName)}</a> (${toSize(doc.sizeBytes)})`
                            ).join('<br>')
                            : '<i>nema</i>');

                        return [
                            `${esc(v.visitType)} — ${fmtDateTime(v.visitDateTime)}`,
                            v.doctorName ?? '',
                            v.notes ?? '',
                            { __html: docsHtml }
                        ];
                    });
                    fillTable('#tblVisits', visitRows);

                } catch (err) {
                    // Ako API vrati 404/500 ovo će se prikazati umjesto “tihe” prazne forme
                    toast(err?.message || 'Greška pri dohvaćanju podataka.');
                }
            }

            // Dodavanje povijesti bolesti
            qsel('#frmMh').addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    const body = {
                        patientId: id,
                        diseaseName: qsel('#mhName').value.trim(),
                        startDate: qsel('#mhStart').value,
                        endDate: qsel('#mhEnd').value || null
                    };
                    await apiPostJson(`/api/patients/${id}/medicalhistory`, body);
                    e.target.reset();
                    await load();
                } catch (err) {
                    toast(err?.message || 'Greška pri spremanju.');
                }
            });

            load();
        });
    </script>
</head>
<body>
    <header class="nav">
        <h1><a id="back" class="btn ghost" href="#">← Natrag</a></h1>
        <nav>
            <a class="btn" href="/index.html">Pacijenti</a>
            <a class="btn ghost" href="/swagger" target="_blank" rel="noopener">Swagger</a>
        </nav>
    </header>

    <main class="stack">
        <section class="card">
            <h2 id="title">Pacijent</h2>
            <div id="pInfo" class="muted"></div>
        </section>

        <section class="card">
            <h3>Povijest bolesti</h3>
            <table class="table" id="tblMh">
                <thead><tr><th>Naziv</th><th>Početak</th><th>Kraj</th></tr></thead>
                <tbody></tbody>
            </table>

            <form id="frmMh" class="row" style="margin-top:12px">
                <label>Bolest<br><input id="mhName" required></label>
                <label>Početak<br><input id="mhStart" type="date" required></label>
                <label>Kraj<br><input id="mhEnd" type="date"></label>
                <button class="btn">+ Dodaj</button>
            </form>
        </section>

        <section class="card">
            <h3>Pregledi</h3>
            <table class="table" id="tblVisits">
                <thead>
                    <tr><th>Pregled</th><th>Liječnik</th><th>Bilješka</th><th>Dokumenti</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </main>
</body>
</html>
